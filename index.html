<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Control de Asistencia en la Empresa Brig Par</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      color: #660000;
    }

    #videoFondo {
      position: fixed;
      top: 0;
      left: 0;
      min-width: 100%;
      min-height: 100%;
      object-fit: cover;
      z-index: -3;
    }

    .overlayOscura {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
      z-index: -2;
    }

    #fondoImagen {
      position: fixed;
      inset: 0;
      background-image: url('fondo.jpg');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index: -3;
      display: none;
    }

    #overlayBlanco {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255, 255, 255, 0.3);
      border: 2px solid #990000;
      z-index: -2;
      display: none;
    }

    .contenido {
      text-align: center;
      padding-top: 30px;
    }

    h1 {
      color: #b30000;
    }

    dialog {
      background-color: #ffe5e5ee;
      padding: 20px;
      border: none;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }

    input, button {
      display: block;
      margin: 10px auto;
      padding: 10px;
      width: 90%;
      max-width: 300px;
      border: 1px solid #cc0000;
      border-radius: 4px;
    }

    button {
      background-color: #cc0000;
      color: white;
      cursor: pointer;
    }

    button:hover {
      background-color: #990000;
    }

    a {
      color: #990000;
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    #registroHoras {
      margin: 20px auto;
      width: 90%;
      max-width: 400px;
      background: #fff0f0cc;
      border: 1px solid #b30000;
      border-radius: 8px;
      padding: 15px;
      text-align: left;
    }

    #registroHoras h3 {
      text-align: center;
      color: #990000;
    }

    #registroHoras ul {
      list-style: none;
      padding: 0;
    }

    #registroHoras li {
      margin-bottom: 6px;
      padding: 4px 0;
      border-bottom: 1px solid #ddd;
    }

    #fotoPerfil {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 2px solid #990000;
      cursor: pointer;
      object-fit: cover;
    }
  </style>
</head>
<body>

  <!-- Fondos -->
  <video autoplay muted loop id="videoFondo">
    <source src="fondo.mp4" type="video/mp4">
    Tu navegador no soporta videos HTML5.
  </video>
  <div class="overlayOscura"></div>
  <div id="fondoImagen"></div>
  <div id="overlayBlanco"></div>

  <div class="contenido">
    <img src="logo-brigpar.png" alt="Logo Brig Par" style="width: 150px; margin-bottom: 15px;">
    <h1>Control de Asistencia en la Empresa Brig Par</h1>

    <!-- Login -->
    <dialog id="loginDialog" open>
      <h2>Iniciar Sesión</h2>
      <input id="userLogin" placeholder="Usuario">
      <input id="passLogin" type="password" placeholder="Contraseña">
      <button onclick="login()">Ingresar</button>
      <p><a href="#" onclick="mostrarRegistro()">¿No tienes cuenta? Regístrate</a></p>
    </dialog>

    <!-- Registro -->
    <dialog id="registroDialog">
      <h2>Registro</h2>
      <input id="nuevoUser" placeholder="Nuevo usuario">
      <input id="nuevoPass1" type="password" placeholder="Contraseña">
      <input id="nuevoPass2" type="password" placeholder="Repetir contraseña">
      <button onclick="registrar()">Registrar</button>
      <p><a href="#" onclick="volverLogin()">Volver al Login</a></p>
    </dialog>

    <!-- Panel principal -->
    <div id="panel" style="display:none; position: relative;">
      <div style="position: fixed; top: 20px; right: 20px; z-index: 10;">
        <label for="fileInput">
          <img id="fotoPerfil" src="https://cdn-icons-png.flaticon.com/512/1144/1144760.png" alt="Perfil">
        </label>
        <input type="file" id="fileInput" accept="image/*" style="display: none;" onchange="cambiarFoto(event)">
      </div>

      <h2 id="bienvenida" style="margin-top: 70px;"></h2>
      <button onclick="marcar('entrada')">Marcar Entrada</button>
      <p id="horaEntrada"></p>
      <button onclick="marcar('salida')">Marcar Salida</button>
      <p id="horaSalida"></p>

      <div id="registroHoras">
        <h3>Historial de Horas</h3>
        <ul id="listaHoras"></ul>
      </div>

      <button onclick="cerrarSesion()" style="background:#660000;">Cerrar Sesión</button>
    </div>
  </div>

  <script>
    let usuarios = JSON.parse(localStorage.getItem("usuarios")) || [{ nombre: "admin", clave: "1234" }];
    let usuarioActivo = localStorage.getItem("usuarioActivo") || "";

    function login() {
      let u = document.getElementById("userLogin").value;
      let p = document.getElementById("passLogin").value;
      let existe = usuarios.find(x => x.nombre === u && x.clave === p);
      if (existe) {
        usuarioActivo = u;
        localStorage.setItem("usuarioActivo", u);
        document.getElementById("bienvenida").innerText = "Hola " + u;
        document.getElementById("loginDialog").close();
        document.getElementById("panel").style.display = "block";
        cargarFotoPerfil();

        document.getElementById("videoFondo").style.display = "none";
        document.querySelector(".overlayOscura").style.display = "none";
        document.getElementById("fondoImagen").style.display = "block";
        document.getElementById("overlayBlanco").style.display = "block";
      } else {
        alert("Usuario o contraseña incorrectos");
      }
    }

    function registrar() {
      let u = document.getElementById("nuevoUser").value;
      let p1 = document.getElementById("nuevoPass1").value;
      let p2 = document.getElementById("nuevoPass2").value;

      if (!u || !p1 || !p2) return alert("Completa todos los campos");
      if (p1 !== p2) return alert("Las contraseñas no coinciden");
      if (usuarios.find(x => x.nombre === u)) return alert("Ese usuario ya existe");

      usuarios.push({ nombre: u, clave: p1 });
      localStorage.setItem("usuarios", JSON.stringify(usuarios));
      alert("Usuario registrado. Ahora puedes iniciar sesión.");
      document.getElementById("registroDialog").close();
      document.getElementById("loginDialog").showModal();
    }

    function mostrarRegistro() {
      document.getElementById("loginDialog").close();
      document.getElementById("registroDialog").showModal();
    }

    function volverLogin() {
      document.getElementById("registroDialog").close();
      document.getElementById("loginDialog").showModal();
    }

    function marcar(tipo) {
      let hora = new Date().toLocaleTimeString();
      const lista = document.getElementById("listaHoras");
      const item = document.createElement("li");
      if (tipo === "entrada") {
        document.getElementById("horaEntrada").innerText = "Entrada: " + hora;
        item.textContent = "Entrada marcada a las " + hora;
      } else {
        document.getElementById("horaSalida").innerText = "Salida: " + hora;
        item.textContent = "Salida marcada a las " + hora;
      }
      lista.appendChild(item);
    }

    function cambiarFoto(event) {
      const archivo = event.target.files[0];
      if (archivo) {
        const lector = new FileReader();
        lector.onload = function(e) {
          document.getElementById("fotoPerfil").src = e.target.result;
          localStorage.setItem("fotoPerfil_" + usuarioActivo, e.target.result);
        };
        lector.readAsDataURL(archivo);
      }
    }

    function cargarFotoPerfil() {
      const guardada = localStorage.getItem("fotoPerfil_" + usuarioActivo);
      if (guardada) {
        document.getElementById("fotoPerfil").src = guardada;
      }
    }

    function cerrarSesion() {
      localStorage.removeItem("usuarioActivo");
      location.reload();
    }

    window.onload = function() {
      if (usuarioActivo) {
        const u = usuarios.find(x => x.nombre === usuarioActivo);
        if (u) {
          document.getElementById("userLogin").value = u.nombre;
          document.getElementById("passLogin").value = u.clave;
          login();
        }
      }
    };
  </script>
</body>
</html>